name: Assign Reviewer

on:
    pull_request:
        types: [opened, ready_for_review]

jobs:
    assign:
        if: github.event.pull_request.draft == false
        runs-on: ubuntu-latest
        steps:
            - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
              id: token
              with:
                  app-id: ${{ secrets.APP_ID }}
                  private-key: ${{ secrets.APP_PEM }}
            - name: Check if author is in terraform-aws team
              id: check_team
              uses: actions/github-script@v7
              with:
                  github-token: ${{ steps.token.outputs.token }}
                  script: |
                      try {
                        console.log(context.repo.owner);       
                        console.log(context.payload.pull_request.user.login);                          
                        await github.rest.teams.getMembershipForUserInOrg({
                          org: context.repo.owner,
                          team_slug: 'terraform-aws',
                          username: context.payload.pull_request.user.login
                        });
                        
                        return true;
                      } catch (error) {
                        console.log(error);
                        return false;
                      }

            - name: Assign reviewer
              if: steps.check_team.outputs.result == 'true'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ steps.token.outputs.token }}
                  script: |
                      // excluded as they are not part of the reviewer rotation.
                      const excluded = ['justinretzolk','marcosentino','vignesh-jayabalan','anurag-hashicorp','breathingdust'];
                      const author = context.payload.pull_request.user.login;

                      const { data: members } = await github.rest.teams.listMembersInOrg({
                        org: context.repo.owner,
                        team_slug: 'terraform-aws'
                      });

                      const eligible = members
                        .map(m => m.login)
                        .filter(login => login !== author && !excluded.includes(login))
                        .sort();

                      if (eligible.length === 0) return;

                      // Count assignments in last 100 PRs
                      const { data: prs } = await github.rest.pulls.list({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: 'all',
                        per_page: 100,
                        sort: 'created',
                        direction: 'desc'
                      });

                      const counts = {};
                      eligible.forEach(login => counts[login] = 0);

                      for (const pr of prs) {
                        for (const reviewer of pr.requested_reviewers || []) {
                          if (counts.hasOwnProperty(reviewer.login)) {
                            counts[reviewer.login]++;
                          }
                        }
                      }

                      const reviewer = eligible.reduce((min, login) => 
                        counts[login] < counts[min] ? login : min
                      );

                      await github.rest.pulls.requestReviewers({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.payload.pull_request.number,
                        reviewers: [reviewer]
                      });
